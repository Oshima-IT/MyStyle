{% extends "admin/base.html" %}
{% block admin_content %}
<div class="card">
    <div class="card-header">
        <h2>Item編集</h2>
        <span class="card-id">#{{ item.id }}</span>
    </div>
    <p class="card-subtitle">アイテム情報の編集・タグ設定ができます。</p>

    <form method="post" class="form">
        <!-- セクション1：基本情報 -->
        <section class="form-section">
            <h3 class="form-section-title">基本情報</h3>

            <div class="form-grid">
                <div class="form-field">
                    <label for="name">Name</label>
                    <input id="name" name="name" type="text" value="{{ item.name }}" required>
                </div>

                <div class="form-field">
                    <label for="category">Category</label>
                    <input id="category" name="category" type="text" value="{{ item.category or '' }}">
                </div>

                <div class="form-field">
                    <label for="image_url">Image URL</label>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <img id="edit_item_preview" class="img-preview" src="{{ item.image_url or '' }}" alt="Preview">
                        <div style="flex: 1; display: flex; gap: 8px;">
                            <input id="image_url" name="image_url" type="url" value="{{ item.image_url or '' }}"
                                style="flex: 1;">
                            <button type="button" class="btn btn-secondary"
                                onclick="openImageSearch('image_url', document.getElementById('name').value, 'edit_item_preview')">画像検索</button>
                        </div>
                    </div>
                </div>

                <div class="form-field">
                    <label for="shop_url">Shop URL</label>
                    <input id="shop_url" name="shop_url" type="url" value="{{ item.shop_url or '' }}">
                </div>

                <div class="form-field">
                    <label for="price">Price</label>
                    <div class="input-prefix">
                        <span>¥</span>
                        <input id="price" name="price" type="number" min="0"
                            value="{{ item.price if item.price is not none else '' }}">
                    </div>
                </div>
            </div>
        </section>

        <!-- セクション2：タグ設定 -->
        <section class="form-section">
            <h3 class="form-section-title">タグ設定</h3>
            <p class="form-section-desc">Styles / Colors とトレンド設定を行います。</p>

            <div class="form-grid">
                <div class="form-field form-field--full">
                    <label>Styles</label>
                    <div class="inline-field">
                        <div class="inline-tags" data-display="styles">
                            <!-- JSで描画されるため空でOK、初期値はJSでセット -->
                        </div>
                        <button type="button" class="btn btn-secondary" data-open-modal="styles"
                            style="min-width: 60px; padding: 4px 10px; font-size: 12px;">選択</button>
                    </div>
                    <input type="hidden" name="styles" id="styles-input" value="{{ item.styles or '' }}">
                </div>

                <div class="form-field form-field--full">
                    <label>Colors</label>
                    <div class="inline-field">
                        <div class="inline-tags" data-display="colors">
                            <!-- JSで描画 -->
                        </div>
                        <button type="button" class="btn btn-secondary" data-open-modal="colors"
                            style="min-width: 60px; padding: 4px 10px; font-size: 12px;">選択</button>
                    </div>
                    <input type="hidden" name="colors" id="colors-input" value="{{ item.colors or '' }}">
                </div>

                <div class="form-field form-field--full trend-field">
                    <label class="checkbox-inline">
                        <input type="checkbox" name="is_trend" value="1" {% if item.is_trend %}checked{% endif %}>
                        トレンドアイテムとして扱う
                    </label>
                </div>
            </div>
        </section>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">保存</button>
            <a href="{{ url_for('admin.admin_items') }}" class="btn btn-secondary">戻る</a>
        </div>
    </form>
</div>
<div class="overlay hidden" id="picker-overlay">
    <div class="modal">
        <div class="modal-header">
            <div id="modal-title">選択</div>
        </div>
        <div class="tag-grid" id="tag-grid"></div>
        <div class="modal-actions">
            <button type="button" class="btn" id="modal-apply">完了</button>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    const STYLE_OPTIONS = ["ストリート", "カジュアル", "モード", "韓国系", "スポーツ", "ヴィンテージ", "ミニマル"];
    const COLOR_OPTIONS = ["黒", "白", "グレー", "ネイビー", "青", "ベージュ", "ブラウン", "緑", "赤"];

    const overlay = document.getElementById("picker-overlay");
    const tagGrid = document.getElementById("tag-grid");
    const modalTitle = document.getElementById("modal-title");
    const modalApply = document.getElementById("modal-apply");

    let currentType = null;

    function renderSelected(type, values) {
        const display = document.querySelector(`[data-display="${type}"]`);
        display.innerHTML = "";
        if (!values.length) {
            const empty = document.createElement("span");
            empty.className = "help-text";
            empty.textContent = "未選択";
            display.appendChild(empty);
            return;
        }
        values.forEach(v => {
            const span = document.createElement("span");
            // 色付きタグかどうかでクラスを分岐
            if (type === "colors") {
                span.className = "tag tag-color";
                // ドットを追加
                const dot = document.createElement("span");
                dot.className = "color-dot";
                dot.dataset.color = v;
                span.appendChild(dot);

                const text = document.createElement("span");
                text.textContent = v;
                span.appendChild(text);
            } else {
                span.className = "tag tag-style";
                span.textContent = v;
            }
            display.appendChild(span);
        });
    }

    function openModal(type) {
        currentType = type;
        const input = document.getElementById(`${type}-input`);
        const selected = input.value ? input.value.split(",") : [];
        tagGrid.innerHTML = "";
        const options = type === "styles" ? STYLE_OPTIONS : COLOR_OPTIONS;
        modalTitle.textContent = type === "styles" ? "Styles を選択" : "Colors を選択";
        options.forEach(opt => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "tag-btn" + (selected.includes(opt) ? " active" : "");
            btn.textContent = opt;
            btn.onclick = () => btn.classList.toggle("active");
            tagGrid.appendChild(btn);
        });
        overlay.classList.remove("hidden");
    }

    function closeModal() {
        overlay.classList.add("hidden");
    }

    document.querySelectorAll("[data-open-modal]").forEach(btn => {
        btn.addEventListener("click", () => openModal(btn.dataset.openModal));
    });
    window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
    });
    modalApply.addEventListener("click", () => {
        if (!currentType) return;
        const input = document.getElementById(`${currentType}-input`);
        const active = Array.from(tagGrid.querySelectorAll(".tag-btn.active")).map(b => b.textContent);
        input.value = active.join(",");
        renderSelected(currentType, active);
        closeModal();
    });

    // 初期表示
    function initDisplay(type) {
        const input = document.getElementById(`${type}-input`);
        const values = input.value ? input.value.split(",") : [];
        renderSelected(type, values);
    }
    initDisplay("styles");
    initDisplay("colors");
</script>
{% endblock %}
{% endblock %}
