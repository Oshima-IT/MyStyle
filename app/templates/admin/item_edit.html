{% extends "admin/base.html" %}
{% block admin_content %}
<div class="card">
    <div class="card-header">
        <h2>Item編集</h2>
        <span class="card-id">#{{ item.id }}</span>
    </div>
    <p class="card-subtitle">アイテム情報の編集・タグ設定ができます。</p>

    <form method="post" class="form">
        <!-- セクション1：基本情報 -->
        <section class="form-section">
            <h3 class="form-section-title">基本情報</h3>

            <div class="form-grid">
                <div class="form-field">
                    <label for="name">Name</label>
                    <input id="name" name="name" type="text" value="{{ item.name }}" required onkeydown="if(event.key==='Enter'){event.preventDefault();openImageSearch('image_url', this.value, 'edit_item_preview', 'edit_item_candidates');}">
                </div>

                <div class="form-field">
                    <label for="category">Category</label>
                    <input id="category" name="category" type="text" value="{{ item.category or '' }}">
                </div>

                <div class="form-field">
                    <label for="image_url">Image URL</label>
                    <div style="display: flex; gap: 8px; align-items: flex-start;">
                        <img id="edit_item_preview" class="img-preview" src="{{ item.image_url or '' }}" alt="Preview">
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                            <div style="display: flex; gap: 8px;">
                                <input id="image_url" name="image_url" type="url" value="{{ item.image_url or '' }}" style="flex: 1;">
                                <button type="button" class="btn btn-secondary w-auto" onclick="openImageSearch('image_url', document.getElementById('name').value, 'edit_item_preview', 'edit_item_candidates')">画像検索</button>
                            </div>
                            <div id="edit_item_candidates" class="candidate-grid"></div>
                        </div>
                    </div>
                </div>

                <div class="form-field">
                    <label for="shop_url">Shop URL</label>
                    <input id="shop_url" name="shop_url" type="url" value="{{ item.shop_url or '' }}">
                </div>

                <div class="form-field">
                    <label for="price">Price</label>
                    <div class="input-prefix">
                        <span>¥</span>
                        <input id="price" name="price" type="number" min="0" value="{{ item.price if item.price is not none else '' }}">
                    </div>
                </div>
            </div>
        </section>

        <!-- セクション2：タグ設定 -->
        <section class="form-section">
            <h3 class="form-section-title">タグ設定</h3>
            <p class="form-section-desc">Styles / Colors とトレンド設定を行います。</p>

            <div class="form-grid">
                <div class="form-field form-field--full">
                    <label class="tag-picker-label">STYLES</label>
                    <div class="inline-field tag-picker" style="height: auto; align-items: flex-start;">
                        <div class="tag-display" data-display="styles">
                            <!-- JSで描画されるため空でOK、初期値はJSでセット -->
                        </div>
                        <button type="button" class="btn btn-add" data-open-modal="styles" style="min-width: auto; padding: 4px 10px; font-size: 11px;">+ ADD</button>
                    </div>
                    <input type="hidden" name="styles" id="styles-input" value="{{ item.styles or '' }}">
                </div>

                <div class="form-field form-field--full">
                    <label class="tag-picker-label">COLORS</label>
                    <div class="inline-field tag-picker" style="height: auto; align-items: flex-start;">
                        <div class="tag-display" data-display="colors">
                            <!-- JSで描画 -->
                        </div>
                        <button type="button" class="btn btn-add" data-open-modal="colors" style="min-width: auto; padding: 4px 10px; font-size: 11px;">+ ADD</button>
                    </div>
                    <input type="hidden" name="colors" id="colors-input" value="{{ item.colors or '' }}">
                </div>

                <div class="form-field">
                    <label for="popularity_score">Popularity Score</label>
                    <input id="popularity_score" name="popularity_score" type="number" min="0" value="{{ item.popularity_score or 0 }}">
                </div>
            </div>
        </section>

        <div class="form-actions">
            <button type="submit" class="btn-black-sharp">保存</button>
            <a href="{{ url_for('admin.admin_items') }}" class="btn btn-secondary">戻る</a>
        </div>
    </form>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ddd; display: flex; justify-content: flex-end;">
        <form action="{{ url_for('admin.admin_item_delete', item_id=item.id) }}" method="post" onsubmit="return confirm('本当にこのアイテムを削除しますか？\nこの操作は取り消せません。');">
            <button type="submit" class="btn btn-danger" style="display: flex; align-items: center; gap: 4px;">
                <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                <span>このアイテムを削除</span>
            </button>
        </form>
    </div>
</div>
<div class="overlay hidden" id="picker-overlay">
    <div class="modal">
        <div class="modal-header">
            <div id="modal-title">選択</div>
        </div>
        <div class="tag-grid" id="tag-grid"></div>
        <div class="modal-actions">
            <button type="button" class="btn" id="modal-apply">完了</button>
        </div>
    </div>
</div>

{% block scripts %}
<script id="style-options-data" type="application/json">
    {{ available_styles | tojson | safe }}
</script>
<script>
    const STYLE_OPTIONS = JSON.parse(document.getElementById('style-options-data').textContent);
    const COLOR_OPTIONS = ["黒", "白", "グレー", "ネイビー", "青", "ベージュ", "ブラウン", "緑", "赤"];

    const overlay = document.getElementById("picker-overlay");
    const tagGrid = document.getElementById("tag-grid");
    const modalTitle = document.getElementById("modal-title");
    const modalApply = document.getElementById("modal-apply");

    let currentType = null;

    function renderSelected(type, values) {
        const display = document.querySelector(`[data-display="${type}"]`);
        if (!display) return;

        // Toggle .has-tags class on parent .tag-picker
        const picker = display.closest(".tag-picker");
        if (picker) {
            if (values.length > 0) {
                picker.classList.add("has-tags");
            } else {
                picker.classList.remove("has-tags");
            }
        }

        display.innerHTML = "";
        if (!values.length) {
            // No text for minimal design
            return;
        }
        values.forEach(v => {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = v;

            const removeBtn = document.createElement("span");
            removeBtn.className = "chip-remove";
            removeBtn.textContent = "×";
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                removeTag(type, v);
            };

            chip.appendChild(removeBtn);
            display.appendChild(chip);
        });
    }

    function removeTag(type, valToRemove) {
        // IDs for item_edit.html are different
        const targetId = type === "styles" ? "styles-input" : "colors-input";
        const input = document.getElementById(targetId);
        if (!input) return;

        const currentVals = input.value ? input.value.split(",").map(s => s.trim()).filter(Boolean) : [];
        const newVals = currentVals.filter(v => v !== valToRemove);
        input.value = newVals.join(",");

        renderSelected(type, newVals);
    }

    function openModal(type) {
        currentType = type;
        const input = document.getElementById(`${type}-input`);

        // Split current values by comma, trim, filter empty
        const rawSelected = input.value ? input.value.split(",").map(s => s.trim()).filter(Boolean) : [];

        tagGrid.innerHTML = "";
        const options = type === "styles" ? STYLE_OPTIONS : COLOR_OPTIONS;
        modalTitle.textContent = type === "styles" ? "SELECT STYLES" : "SELECT COLORS";

        // Determine which are presets and which are custom
        const optionsSet = new Set(options);
        const presetSelected = [];
        const customSelected = [];

        rawSelected.forEach(s => {
            if (optionsSet.has(s)) {
                presetSelected.push(s);
            } else {
                customSelected.push(s);
            }
        });

        // Render Preset Buttons
        options.forEach(opt => {
            const isActive = presetSelected.includes(opt);
            const btn = createTagCheckBtn(opt, isActive);
            tagGrid.appendChild(btn);
        });

        // Add "Other" trigger button and hidden input
        const otherBtn = document.createElement("button");
        otherBtn.type = "button";
        otherBtn.className = "tag-btn other-trigger";
        otherBtn.textContent = "+ OTHER";
        otherBtn.style.borderStyle = "dashed";

        const otherInput = document.createElement("input");
        otherInput.type = "text";
        otherInput.className = "tag-input";
        otherInput.style.display = "none";
        otherInput.style.minWidth = "200px";
        otherInput.placeholder = "タグを入力 (カンマ区切り可)";
        otherInput.value = customSelected.join(","); // Populate existing custom tags

        // Toggle logic
        const showInput = () => {
            otherBtn.style.display = "none";
            otherInput.style.display = "inline-block";
        };
        const showBtn = () => {
            otherBtn.style.display = "inline-block";
            otherInput.style.display = "none";
        };

        otherBtn.onclick = () => {
            showInput();
            otherInput.focus();
        };

        // If we have custom tags, show input by default
        if (customSelected.length > 0) {
            showInput();
        } else {
            showBtn();
        }

        otherInput.onkeydown = (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                // Check if user meant to add?
                // Logic says just complete on Apply.
            }
        };

        otherInput.onblur = () => {
            if (!otherInput.value.trim()) {
                showBtn();
            }
        };

        tagGrid.appendChild(otherBtn);
        tagGrid.appendChild(otherInput);

        overlay.classList.remove("hidden");
    }

    function createTagCheckBtn(text, isActive) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tag-btn" + (isActive ? " active" : "");
        btn.textContent = text;
        btn.onclick = () => btn.classList.toggle("active");
        return btn;
    }

    function closeModal() {
        overlay.classList.add("hidden");
    }

    document.querySelectorAll("[data-open-modal]").forEach(btn => {
        btn.addEventListener("click", () => openModal(btn.dataset.openModal));
    });
    window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
    });

    modalApply.addEventListener("click", () => {
        if (!currentType) return;
        const input = document.getElementById(`${currentType}-input`);

        // Gather Active Buttons
        const activePresets = Array.from(tagGrid.querySelectorAll(".tag-btn.active:not(.other-trigger)")).map(b => b.textContent);

        // Gather Other Input
        const otherInput = tagGrid.querySelector("input.tag-input");
        const customValue = otherInput ? otherInput.value.trim() : "";
        const customTags = customValue ? customValue.split(",").map(s => s.trim()).filter(Boolean) : [];

        // Combine
        const allTags = new Set([...activePresets, ...customTags]);
        input.value = Array.from(allTags).join(",");

        renderSelected(currentType, Array.from(allTags));
        closeModal();
    });

    // 初期表示
    function initDisplay(type) {
        const input = document.getElementById(`${type}-input`);
        const values = input.value ? input.value.split(",") : [];
        renderSelected(type, values);
    }
    initDisplay("styles");
    initDisplay("colors");
</script>
{% endblock %}
{% endblock %}
