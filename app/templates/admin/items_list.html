{% extends "admin/base.html" %}
{% block admin_content %}
<div class="split">
    <div class="card" style="padding-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">Items</h2>
            <div class="admin-sort-controls">
                <select id="sort-select" class="admin-select" style="padding: 4px 8px; font-size: 13px; border: 1px solid #ddd; background: #fff;">
                    <option value="score" {% if sort_by=='score' %}selected{% endif %}>
                        スコア順
                    </option>
                    <option value="date" {% if sort_by=='date' %}selected{% endif %}>
                        追加日順
                    </option>
                </select>
            </div>
        </div>

        <script>
            document.getElementById('sort-select').addEventListener('mousedown', function (e) {
                // If the user clicks the already selected option, toggle order
                this._preClickValue = this.value;
            });

            document.getElementById('sort-select').addEventListener('change', function () {
                const sort = this.value;
                let order = 'desc';

                // If it was already selected, toggle direction
                const currentSort = "{{ sort_by }}";
                const currentOrder = "{{ order }}";

                if (sort === currentSort) {
                    order = currentOrder === 'desc' ? 'asc' : 'desc';
                }

                window.location.href = `{{ url_for('admin.admin_items') }}?sort=${sort}&order=${order}`;
            });

            // Handle the "click same to toggle" logic by re-selecting after change or manual trigger
            // Note: Standard <select> change triggers only on different values.
            // For true 2-option toggle behavior, we might need a slightly different UI,
            // but let's try this simple logic first: Selecting the other one switches to it (DESC).
            // Selecting the CURRENT one again (if possible via UI) toggles it.
        </script>
        <div class="admin-list">
            {% for item in items %}
            <div class="admin-card-row">
                <div class="admin-card-image">
                    <img src="{{ item.image_url or url_for('static', filename='images/no_image.png') }}" alt="{{ item.name }}" loading="lazy">
                </div>
                <div class="admin-card-main">
                    <div class="admin-card-title">
                        <!-- <span class="admin-card-id">#{{ item.id }}</span> -->
                        <span class="admin-card-name">{{ item.name }}</span>
                        {% if item.popularity_score %}
                        <span class="tag tag-trend">Score: {{ item.popularity_score }}</span>
                        {% endif %}
                        <span class="admin-card-stats" style="font-size: 11px; color: #666; margin-left: 8px;">
                            (V:{{ item.stats_summary.views }}, C:{{ item.stats_summary.clicks }}, S:{{ item.stats_summary.saves }})
                        </span>
                    </div>

                    <div class="admin-card-meta">
                        {% if item.category %}
                        <span class="tag tag-meta">{{ item.category }}</span>
                        {% endif %}
                        {% if item.price_min %}
                        <span class="tag tag-meta">¥{{ item.price_min }}</span>
                        {% endif %}
                        {# Priceがitem.priceの場合はこちら #}
                        {% if item.price %}
                        <span class="tag tag-meta">¥{{ item.price }}</span>
                        {% endif %}
                    </div>

                    <div class="admin-card-tags">
                        {% if item.styles %}
                        <span class="tag-label">Styles:</span>
                        {% for s in item.styles.split(',') %}
                        <span class="tag tag-style">{{ s }}</span>
                        {% endfor %}
                        {% endif %}

                        {% if item.colors %}
                        <span class="tag-label">Colors:</span>
                        {% for c in item.colors.split(',') %}
                        <span class="tag tag-color">
                            <span class="color-dot" data-color="{{ c }}"></span>
                            <span>{{ c }}</span>
                        </span>
                        {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <div class="admin-card-actions">
                    <a class="btn btn-secondary btn-icon" href="{{ url_for('admin.admin_item_edit', item_id=item.id) }}">
                        <span class="material-symbols-outlined">edit</span>
                    </a>
                    <form action="{{ url_for('admin.admin_item_delete', item_id=item.id) }}" method="post" onsubmit="return confirm('削除しますか？');">
                        <button class="btn btn-danger btn-icon" type="submit">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </form>
                </div>
            </div>
            {% else %}
            <p class="admin-empty">No items.</p>
            {% endfor %}
        </div>

        {% if total_pages > 1 %}
        <div class="pagination">
            <a href="{{ url_for('admin.admin_items', page=page-1, sort=sort_by, order=order) }}" class="btn btn-secondary btn-icon {% if page == 1 %}disabled{% endif %}">
                <span class="material-symbols-outlined">chevron_left</span>
            </a>
            <a href="{{ url_for('admin.admin_items', page=page+1, sort=sort_by, order=order) }}" class="btn btn-secondary btn-icon {% if page == total_pages %}disabled{% endif %}">
                <span class="material-symbols-outlined">chevron_right</span>
            </a>
        </div>
        {% endif %}
    </div>
    <div class="card">
        <h2 style="margin: 0; margin-bottom: 20px;">Itemを追加</h2>
        <form method="post">
            <div>
                <label>Name</label>
                <input type="text" id="new_item_name" name="name" required onkeydown="if(event.key==='Enter'){event.preventDefault();openImageSearch('new_item_image_url', this.value, 'new_item_preview', 'new_item_candidates');}">
            </div>

            <div>
                <label>Shop URL</label>
                <input type="text" name="shop_url">
            </div>
            <div>
                <label>Price</label>
                <input type="number" name="price" min="0">
            </div>
            <div>
                <div>
                    <label class="tag-picker-label">CATEGORY</label>
                    <div class="tag-picker">
                        <div class="tag-display" data-display="category"></div>
                        <input type="hidden" name="category" id="new_item_category">
                        <div class="actions">
                            <button type="button" class="btn btn-add" data-open-modal="category" data-target-id="new_item_category">+ ADD</button>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <div>
                    <label class="tag-picker-label">STYLES</label>
                    <div class="tag-picker">
                        <div class="tag-display" data-display="styles"></div>
                        <input type="hidden" name="styles" id="new_item_styles">
                        <div class="actions">
                            <button type="button" class="btn btn-add" data-open-modal="styles" data-target-id="new_item_styles">+ ADD</button>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <div>
                    <label class="tag-picker-label">COLORS</label>
                    <div class="tag-picker">
                        <div class="tag-display" data-display="colors"></div>
                        <input type="hidden" name="colors" id="new_item_colors">
                        <div class="actions">
                            <button type="button" class="btn btn-add" data-open-modal="colors" data-target-id="new_item_colors">+ ADD</button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label>Image URL</label>
                <div style="display: flex; gap: 8px; align-items: flex-start;">
                    <img id="new_item_preview" class="img-preview" alt="Preview">
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="new_item_image_url" name="image_url" style="flex: 1;">
                            <button type="button" class="btn btn-secondary w-auto" onclick="openImageSearch('new_item_image_url', document.getElementById('new_item_name').value, 'new_item_preview', 'new_item_candidates')">画像検索</button>
                        </div>
                        <!-- Candidates Container -->
                        <div id="new_item_candidates" class="candidate-grid"></div>
                    </div>
                </div>
            </div>


            <div class="actions">
                <button type="submit" class="btn-black-sharp w-full">追加</button>
            </div>
        </form>
    </div>
</div>

<div class="overlay hidden" id="picker-overlay">
    <div class="modal">
        <div class="modal-header">
            <div id="modal-title">選択</div>
        </div>
        <div class="tag-grid" id="tag-grid"></div>
        <div class="modal-actions">
            <button type="button" class="btn" id="modal-apply">完了</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    console.log("Admin Items Script initializing...");

    const STYLE_OPTIONS = {{ available_styles | tojson | safe }};
    const COLOR_OPTIONS = ["黒", "白", "グレー", "ネイビー", "青", "ベージュ", "ブラウン", "緑", "赤"];
    const CATEGORY_OPTIONS = {{ available_categories | tojson | safe }};

    const overlay = document.getElementById("picker-overlay");
    const tagGrid = document.getElementById("tag-grid");
    const modalTitle = document.getElementById("modal-title");
    const modalApply = document.getElementById("modal-apply");

    let currentType = null;
    let currentTargetId = null;

    function renderSelected(type, values) {
        const display = document.querySelector(`[data-display="${type}"]`);
        if (!display) return;
        const picker = display.closest(".tag-picker");
        if (picker) {
            if (values.length > 0) picker.classList.add("has-tags");
            else picker.classList.remove("has-tags");
        }
        display.innerHTML = "";
        values.forEach(v => {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = v;
            const removeBtn = document.createElement("span");
            removeBtn.className = "chip-remove";
            removeBtn.textContent = "×";
            removeBtn.onclick = (e) => { e.stopPropagation(); removeTag(type, v); };
            chip.appendChild(removeBtn);
            display.appendChild(chip);
        });
    }

    function removeTag(type, valToRemove) {
        let targetId;
        if (type === "styles") targetId = "new_item_styles";
        else if (type === "colors") targetId = "new_item_colors";
        else if (type === "category") targetId = "new_item_category";
        const input = document.getElementById(targetId);
        if (!input) return;
        const currentVals = input.value ? input.value.split(",").map(s => s.trim()).filter(Boolean) : [];
        const newVals = currentVals.filter(v => v !== valToRemove);
        input.value = newVals.join(",");
        renderSelected(type, newVals);
    }

    window.openModal = function (type, targetId) {
        console.log("openModal called:", type, targetId);
        currentType = type;
        currentTargetId = targetId;
        const input = document.getElementById(currentTargetId);
        if (!input) return;
        const rawSelected = input.value ? input.value.split(",").map(s => s.trim()).filter(Boolean) : [];
        tagGrid.innerHTML = "";
        let options = [];
        if (type === "styles") options = STYLE_OPTIONS;
        else if (type === "colors") options = COLOR_OPTIONS;
        else if (type === "category") options = CATEGORY_OPTIONS;
        const optionsSet = new Set(options);
        const presetSelected = [];
        const customSelected = [];
        rawSelected.forEach(s => {
            if (optionsSet.has(s)) presetSelected.push(s);
            else customSelected.push(s);
        });
        options.forEach(opt => {
            const isActive = presetSelected.includes(opt);
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "tag-btn" + (isActive ? " active" : "");
            btn.textContent = opt;
            btn.onclick = () => btn.classList.toggle("active");
            tagGrid.appendChild(btn);
        });
        const otherBtn = document.createElement("button");
        otherBtn.type = "button";
        otherBtn.className = "tag-btn other-trigger";
        otherBtn.textContent = "+ OTHER";
        otherBtn.style.borderStyle = "dashed";
        const otherInput = document.createElement("input");
        otherInput.type = "text";
        otherInput.className = "tag-input";
        otherInput.style.display = "none";
        otherInput.style.minWidth = "200px";
        otherInput.placeholder = "タグを入力 (カンマ区切り可)";
        otherInput.value = customSelected.join(",");
        const showInput = () => { otherBtn.style.display = "none"; otherInput.style.display = "inline-block"; };
        const showBtn = () => { otherBtn.style.display = "inline-block"; otherInput.style.display = "none"; };
        otherBtn.onclick = () => { showInput(); otherInput.focus(); };
        if (customSelected.length > 0) showInput();
        else showBtn();
        otherInput.onblur = () => { if (!otherInput.value.trim()) showBtn(); };
        tagGrid.appendChild(otherBtn);
        tagGrid.appendChild(otherInput);
        overlay.classList.remove("hidden");
    };

    window.closeModal = function () {
        if (overlay) overlay.classList.add("hidden");
        currentType = null;
        currentTargetId = null;
    };

    function initScripts() {
        document.querySelectorAll("[data-open-modal]").forEach(btn => {
            btn.addEventListener("click", () => openModal(btn.dataset.openModal, btn.dataset.targetId));
        });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initScripts);
    else initScripts();

    window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    if (modalApply) {
        modalApply.addEventListener("click", () => {
            if (!currentType || !currentTargetId) return;
            const input = document.getElementById(currentTargetId);
            const activePresets = Array.from(tagGrid.querySelectorAll(".tag-btn.active:not(.other-trigger)")).map(b => b.textContent);
            const otherInput = tagGrid.querySelector("input.tag-input");
            const customValue = otherInput ? otherInput.value.trim() : "";
            const customTags = customValue ? customValue.split(",").map(s => s.trim()).filter(Boolean) : [];
            const allTags = new Set([...activePresets, ...customTags]);
            input.value = Array.from(allTags).join(",");
            renderSelected(currentType, Array.from(allTags));
            closeModal();
        });
    }
</script>
{% endblock %}
