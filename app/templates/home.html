{% extends "base.html" %}

{% block title %}MyStyle - ホーム{% endblock %}

{% block content %}

<!-- ▼ タブ（ホーム / トレンド / 天気おすすめ） -->
<div class="page-tabs">
    <a href="{{ url_for('home') }}" class="tab active">ホーム</a>
    <a href="{{ url_for('trends') }}" class="tab">トレンド</a>
    <a href="{{ url_for('weather') }}" class="tab">天気おすすめ</a>
</div>

<section class="style-section-minimal">
    <h3>あなたの系統</h3>

    {% if current_styles %}
    <div style="margin-bottom: 4px;">
        {% for s in current_styles %}
        <span class="tag-sharp">{{ s }}</span>
        {% endfor %}
    </div>
    {% else %}
    <p style="font-size:0.9em; color:#888;">未設定</p>
    {% endif %}

    <div style="text-align: left;">
        <button class="btn-text-link open-style-modal">EDIT STYLES</button>
    </div>
</section>

<section class="photo-display-area">
    <h3>おすすめアイテム</h3>

    <div class="photo-scroll">

        {% for item in items %}
        <div class="item-card">
            <a href="/detail/{{ item.id }}" class="img-link">
                <figure class="img-wrapper">
                    {% if item.styles %}
                    <span class="badge-style">{{ item.styles }}</span>
                    {% endif %}
                    <img src="{{ item.image_url }}" alt="{{ item.name }}" loading="lazy">
                </figure>
            </a>
            <div class="info">
                <a href="/detail/{{ item.id }}" class="name-link">
                    <h4 class="name">{{ item.name }}</h4>
                </a>

                <div class="card-footer">
                    <p class="price">{{ item.price }}<span class="currency">円</span></p>
                    <a href="/detail/{{ item.id }}" class="view-details-btn">VIEW DETAILS</a>
                </div>
            </div>
        </div>
        {% endfor %}

    </div>
</section>

{% if recent_history %}
<section class="card">
    <h3>最近見たアイテム</h3>
    <div class="history-strip">
        {% for h in recent_history %}
        <div class="history-card">
            <a href="/detail/{{ h.id }}">
                {% if h.image_url %}
                <img src="{{ h.image_url }}" loading="lazy" alt="{{ h.name }}">
                {% else %}
                <div class="placeholder"></div>
                {% endif %}
            </a>
            <div class="history-meta">
                <div class="name">{{ h.name }}</div>
                <div class="price">{{ h.price or '0' }}<span style="font-size:0.8em">円</span></div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if saved_items %}
<section class="card">
    <h3>お気に入り</h3>
    <div class="history-strip">
        {% for s in saved_items %}
        <div class="history-card">
            <a href="/detail/{{ s.id }}">
                {% if s.image_url %}
                <img src="{{ s.image_url }}" loading="lazy" alt="{{ s.name }}">
                {% else %}
                <div class="placeholder"></div>
                {% endif %}
            </a>
            <div class="history-meta">
                <div class="name">{{ s.name }}</div>
                <div class="price">{{ s.price or '0' }}<span style="font-size:0.8em">円</span></div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Home modal trigger -->
<!-- 固定ボタンは削除（カード内のボタンを使用） -->

<!-- Overlay modal -->
<div class="overlay hidden" id="styleOverlay">
    <div class="modal" role="dialog" aria-hidden="true">
        <div class="modal-header">系統を選択</div>
        <div class="tag-grid">
            {% for s in available_styles %}
            <button class="tag-btn {% if s in current_styles %}active{% endif %}" data-style="{{ s }}">{{ s }}</button>
            {% endfor %}
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancel-style">キャンセル</button>
            <button class="btn" id="save-style">保存</button>
        </div>
    </div>
</div>

<script>
    // open modal from any trigger with the .open-style-modal class
    document.querySelectorAll('.open-style-modal').forEach(el => {
        el.addEventListener('click', function () {
            const ov = document.getElementById('styleOverlay');
            ov.classList.remove('hidden');
            ov.querySelector('.modal').setAttribute('aria-hidden', 'false');
        });
    });
    document.getElementById('cancel-style').addEventListener('click', function () {
        const ov = document.getElementById('styleOverlay');
        ov.classList.add('hidden');
        ov.querySelector('.modal').setAttribute('aria-hidden', 'true');
    });

    // toggle active
    document.querySelectorAll('.tag-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
        });
    });

    document.getElementById('save-style').addEventListener('click', async () => {
        const active = [...document.querySelectorAll('.tag-btn.active')].map(b => b.getAttribute('data-style'));
        const form = new FormData();
        active.forEach(s => form.append('style', s));
        await fetch("{{ url_for('update_styles') }}", { method: 'POST', body: form });
        window.location.reload();
    });
</script>

{% endblock %}
