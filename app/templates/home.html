{% extends "base.html" %}

{% block title %}MyStyle - ホーム{% endblock %}

{% block content %}

<!-- ▼ タブ（ホーム / トレンド / 天気おすすめ） -->
<div class="page-tabs">
    <a href="{{ url_for('home') }}" class="tab active">ホーム</a>
    <a href="{{ url_for('trends') }}" class="tab">トレンド</a>
    <a href="{{ url_for('weather') }}" class="tab">天気おすすめ</a>
</div>

<section class="style-section-minimal">
    <h3>あなたの系統</h3>

    {% if current_styles %}
    <div style="margin-bottom: 4px;">
        {% for s in current_styles %}
        <span class="tag-sharp">{{ s }}</span>
        {% endfor %}
    </div>
    {% else %}
    <p style="font-size:0.9em; color:#888;">未設定</p>
    {% endif %}

    <div style="text-align: left;">
        <button class="btn-text-link open-style-modal">EDIT STYLES</button>
    </div>
</section>

<section class="photo-display-area">
    <h3>おすすめアイテム</h3>

    <div class="photo-scroll">

        {% for item in items %}
        <div class="item-card">
            <a href="/detail/{{ item.id }}" class="img-link">
                <figure class="img-wrapper">
                    {% if item.styles %}
                    <span class="badge-style">{{ item.styles }}</span>
                    {% endif %}
                    <img src="{{ item.image_url }}" alt="{{ item.name }}" loading="lazy">
                </figure>
            </a>
            <div class="info">
                <a href="/detail/{{ item.id }}" class="name-link">
                    <h4 class="name">{{ item.name }}</h4>
                </a>

                <div class="card-footer">
                    <p class="price">{{ item.price }}<span class="currency">円</span></p>
                    <a href="/detail/{{ item.id }}" class="view-details-btn">VIEW DETAILS</a>
                </div>
            </div>
        </div>
        {% endfor %}

    </div>
</section>

{% if recent_history %}
<section class="card">
    <h3>最近見たアイテム</h3>
    <div class="history-strip">
        {% for h in recent_history %}
        <div class="history-card">
            <a href="/detail/{{ h.id }}">
                {% if h.image_url %}
                <img src="{{ h.image_url }}" loading="lazy" alt="{{ h.name }}">
                {% else %}
                <div class="placeholder"></div>
                {% endif %}
            </a>
            <div class="history-meta">
                <div class="name">{{ h.name }}</div>
                <div class="price">{{ h.price or '0' }}<span style="font-size:0.8em">円</span></div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{% if saved_items %}
<section class="card">
    <h3>お気に入り</h3>
    <div class="history-strip">
        {% for s in saved_items %}
        <div class="history-card">
            <a href="/detail/{{ s.id }}">
                {% if s.image_url %}
                <img src="{{ s.image_url }}" loading="lazy" alt="{{ s.name }}">
                {% else %}
                <div class="placeholder"></div>
                {% endif %}
            </a>
            <div class="history-meta">
                <div class="name">{{ s.name }}</div>
                <div class="price">{{ s.price or '0' }}<span style="font-size:0.8em">円</span></div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Feature Explanation Cards -->
<section class="feature-explanation-section">
    <h3 style="text-align: center; margin-bottom: 2rem; font-size: 1.5rem;">機能説明</h3>

    <div class="feature-cards-grid">
        <!-- Recommended Items Card -->
        <div class="feature-card">
            <div class="feature-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
            </div>
            <h4 class="feature-title">おすすめアイテム</h4>
            <div class="feature-description">
                <p><strong>仕様:</strong> あなたが設定した「系統」(スタイル)に合致するアイテムを優先的に表示します。</p>
                <p><strong>ロジック:</strong> アイテムの系統タグとユーザーの好みを照合し、人気度スコア(閲覧数・クリック数・保存数)でランク付けします。</p>
                <p><strong>用途:</strong> 自分の好みに合った新しいアイテムを効率的に発見できます。系統を編集することで、表示内容をカスタマイズ可能です。</p>
            </div>
        </div>

        <!-- Recently Viewed Card -->
        <div class="feature-card">
            <div class="feature-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                </svg>
            </div>
            <h4 class="feature-title">最近見たアイテム</h4>
            <div class="feature-description">
                <p><strong>仕様:</strong> 直近で閲覧したアイテムを最大10件まで時系列順に表示します。</p>
                <p><strong>ロジック:</strong> ログインユーザーはFirestoreに、ゲストユーザーはブラウザCookieに閲覧履歴を保存。ログイン時に履歴が自動的に統合されます。</p>
                <p><strong>用途:</strong> 気になったアイテムを後から簡単に見返すことができます。比較検討や再訪問に便利です。</p>
            </div>
        </div>

        <!-- Favorites Card -->
        <div class="feature-card">
            <div class="feature-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </div>
            <h4 class="feature-title">お気に入り</h4>
            <div class="feature-description">
                <p><strong>仕様:</strong> 保存したアイテムを一覧表示。保存日時の新しい順に最大10件まで表示されます。</p>
                <p><strong>ロジック:</strong> 詳細ページのハートアイコンをクリックすることで保存/解除が可能。ログインユーザーはFirestore、ゲストはCookieで管理されます。</p>
                <p><strong>用途:</strong> 購入候補やコーディネートの参考にしたいアイテムを保存しておくことで、いつでもアクセスできます。</p>
            </div>
        </div>
    </div>
</section>

<!-- Home modal trigger -->
<!-- 固定ボタンは削除（カード内のボタンを使用） -->

<!-- Overlay modal -->
<div class="overlay hidden" id="styleOverlay">
    <div class="modal" role="dialog" aria-hidden="true">
        <div class="modal-header">系統を選択</div>
        <div class="tag-grid">
            {% for s in available_styles %}
            <button class="tag-btn {% if s in current_styles %}active{% endif %}" data-style="{{ s }}">{{ s }}</button>
            {% endfor %}
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancel-style">キャンセル</button>
            <button class="btn" id="save-style">保存</button>
        </div>
    </div>
</div>

<script>
    // open modal from any trigger with the .open-style-modal class
    document.querySelectorAll('.open-style-modal').forEach(el => {
        el.addEventListener('click', function () {
            const ov = document.getElementById('styleOverlay');
            ov.classList.remove('hidden');
            ov.querySelector('.modal').setAttribute('aria-hidden', 'false');
        });
    });
    document.getElementById('cancel-style').addEventListener('click', function () {
        const ov = document.getElementById('styleOverlay');
        ov.classList.add('hidden');
        ov.querySelector('.modal').setAttribute('aria-hidden', 'true');
    });

    // toggle active
    document.querySelectorAll('.tag-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
        });
    });

    document.getElementById('save-style').addEventListener('click', async () => {
        const active = [...document.querySelectorAll('.tag-btn.active')].map(b => b.getAttribute('data-style'));
        const form = new FormData();
        active.forEach(s => form.append('style', s));
        await fetch("{{ url_for('update_styles') }}", { method: 'POST', body: form });
        window.location.reload();
    });
</script>

{% endblock %}
