{% extends "base.html" %}

{% block title %}MyStyle - トレンド{% endblock %}

{% block content %}

<!-- ▼ タブ（ホーム / トレンド / 天気おすすめ） -->
<div class="page-tabs">
    <a href="{{ url_for('home') }}" class="tab">ホーム</a>
    <a href="{{ url_for('trends') }}" class="tab active">トレンド</a>
    <a href="{{ url_for('weather') }}" class="tab">天気おすすめ</a>
</div>

<div id="trends" class="trends-page">
    <div class="trends-hero">
        <div class="trends-hero-left">
            <h2 class="trends-title">今週のスタイルトレンド</h2>
            <p class="trends-desc">
                Wikipediaの閲覧数（{{ wiki.source }}）から直近7日で伸びているスタイルをランキング表示します。
            </p>
        </div>

        <div class="trends-meta">
            <div class="meta-chip">
                <span class="meta-label">UPDATED</span>
                <span class="meta-value">{{ wiki.updated_at[:16].replace("T"," ") if wiki.updated_at else "—" }}</span>
            </div>
            {% if wiki.stale %}
            <div class="meta-chip is-warn">
                <span class="meta-label">STATUS</span>
                <span class="meta-value">キャッシュ表示（更新失敗）</span>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="trends-note">
        “知る → 探す” の導線で、関連アイテムをホーム側で検索します。
    </div>

    <div class="trend-grid">
        {% for t in wiki.trends %}
        <details class="trend-card {% if loop.index == 1 %}is-top{% endif %} {% if t.growth < 0 %}is-down{% else %}is-up{% endif %}">
            <summary class="trend-summary">
                <div class="trend-card-head">
                    <div class="trend-rank">{{ loop.index }}</div>

                    <div class="trend-main">
                        <div class="trend-name-row">
                            <div class="trend-name">{{ t.label }}</div>
                            <div class="trend-article">({{ t.article }})</div>
                        </div>
                        <div class="trend-sub">
                            7日間の推移: <span class="trend-pv">{{ t.series[0].views }}</span> →
                            <span class="trend-pv">{{ t.series[-1].views }}</span>
                        </div>
                    </div>

                    <div class="trend-metric">
                        <div class="trend-growth">{{ (t.growth*100)|round(1) }}%</div>
                        <div class="trend-growth-label">{% if t.growth < 0 %}減少{% else %}増加{% endif %}</div>
                        </div>
                    </div>

                    <div class="trend-chevron">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
            </summary>

            <div class="trend-items-expander">
                {% if t.trend_items %}
                <div class="trend-item-grid">
                    {% for item in t.trend_items %}
                    <a href="/detail/{{ item.id }}" class="trend-item-thumb">
                        <div class="ti-img-box">
                            {% if item.image_url %}
                            <img src="{{ item.image_url }}" alt="{{ item.name }}" loading="lazy">
                            {% else %}
                            <div class="no-img">No Img</div>
                            {% endif %}
                        </div>
                        <div class="ti-info">
                            <div class="ti-brand">{{ item.brand|default('BRAND') }}</div>
                            <div class="ti-price">¥{{ "{:,}".format(item.price|default(0)|int) }}</div>
                        </div>
                    </a>
                    {% endfor %}
                    {% else %}
                    <div class="trend-no-items">
                        <p>関連アイテムが見つかりませんでした。</p>
                        <a href="/home?search={{ t.label|urlencode }}" class="btn-trend-sm">検索してみる</a>
                    </div>
                    {% endif %}
                </div>
        </details>
        {% endfor %}
    </div>
</div>




{# DBのトレンド情報を必ず表示 #}
{% if trends and trends|length > 0 %}
{% for t in trends %}
<div class="card">
    <h3>{{ t.title }}</h3>
    {% if t.image_url %}
    <img src="{{ t.image_url }}" alt="{{ t.title }}" style="width:100%; max-width:400px; border-radius:8px; margin-bottom:12px;">
    {% endif %}
    <p>{{ t.description }}</p>
</div>
{% endfor %}
{% endif %}

{% endblock %}
